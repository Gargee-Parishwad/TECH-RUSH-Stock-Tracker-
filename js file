// script.js

const API_KEY = "e2d5347462894735ab48945ad36dbc85";
let stockChart = null;
let refreshTimer = null;

async function getStockData() {
  const symbol = document.getElementById("symbol").value.trim().toUpperCase();
  const resultDiv = document.getElementById("result");
  if (!symbol) {
    resultDiv.innerHTML = "‚ö†Ô∏è Please enter a stock symbol.";
    return;
  }

  resultDiv.innerHTML = "‚è≥ Fetching‚Ä¶";

  try {
    const url = `https://finnhub.io/api/v1/quote?symbol=${symbol}&token=${API_KEY}`;
    const resp = await fetch(url);
    const data = await resp.json();
    // data.c = current price, data.dp = percent change
    if (data.c === 0 && data.o === 0 && data.pc === 0) {
      resultDiv.innerHTML = "‚ùå Invalid symbol or no data.";
      return;
    }

    const now = new Date().toLocaleTimeString();
    const price = parseFloat(data.c).toFixed(2);
    const pct  = parseFloat(data.dp).toFixed(2);

    // show latest
    resultDiv.innerHTML = `
      ‚úÖ <strong>${symbol}</strong><br>
      üí∞ Price: $${price}<br>
      üìà Change: ${pct}%<br>
      üïí ${now}
    `;

    // update chart
    updateChart(symbol, now, price);
  } catch (err) {
    console.error(err);
    resultDiv.innerHTML = "‚ùå Error fetching data.";
  }
}

function updateChart(symbol, label, price) {
  // lazy-create canvas if needed
  let canvas = document.getElementById("priceChart");
  if (!canvas) {
    canvas = document.createElement("canvas");
    canvas.id = "priceChart";
    canvas.style.width = "100%";
    canvas.style.height = "300px";
    document.querySelector(".tracker").appendChild(canvas);
  }
  const ctx = canvas.getContext("2d");

  if (!stockChart) {
    stockChart = new Chart(ctx, {
      type: "line",
      data: {
        labels: [label],
        datasets: [{
          label: `${symbol} Price`,
          data: [price],
          fill: true,
          tension: 0.4,
          borderColor: "#10b981",
          backgroundColor: "rgba(16,185,129,0.2)"
        }]
      },
      options: {
        responsive: true,
        scales: {
          x: { display: true },
          y: {
            beginAtZero: false,
            ticks: {
              callback: v => `$${v}`
            }
          }
        }
      }
    });
  } else {
    stockChart.data.labels.push(label);
    stockChart.data.datasets[0].data.push(price);
    stockChart.update();
  }
}

function startTracking() {
  // clear old timer
  if (refreshTimer) clearInterval(refreshTimer);

  // fetch immediately, then every 60s
  getStockData();
  refreshTimer = setInterval(getStockData, 60_000);
}

// wire up your "Track" button
document.querySelector("button").addEventListener("click", startTracking);
